#!/usr/bin/env bash
set -euo pipefail

_find_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.git" ]] || [[ -d "$dir/.gitsim" ]]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    if [[ -d "$dir/.git" ]] || [[ -d "$dir/.gitsim" ]]; then echo "$dir"; return 0; fi
    return 1
}
REPO_ROOT="$(_find_root)"

# For real git. This will not work for gitsim. Acceptable limitation.
if [[ -d "$REPO_ROOT/.git" ]] && git diff --name-only HEAD@{1} HEAD 2>/dev/null | grep -q "^locker.age$"; then
    echo "üîÑ Locker updated in merge, refreshing..."
    if ! "$REPO_ROOT/bin/padlock" unlock 2>/dev/null; then
        echo "‚ö†Ô∏è  Cannot decrypt updated locker (missing keys?)"
    fi
fi
