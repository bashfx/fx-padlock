#!/usr/bin/env bash
set -euo pipefail

_find_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.git" ]] || [[ -d "$dir/.gitsim" ]]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    if [[ -d "$dir/.git" ]] || [[ -d "$dir/.gitsim" ]]; then echo "$dir"; return 0; fi
    return 1
}
REPO_ROOT="$(_find_root)"

if [[ -d "$REPO_ROOT/locker" ]] && [[ -n "$(find "$REPO_ROOT/locker" -type f 2>/dev/null)" ]]; then
    echo "ðŸ” Encrypting locker/ â†’ locker.age"
    if "$REPO_ROOT/bin/padlock" lock; then
        # This part is tricky because gitsim doesn't have a staging area like git.
        # For real git, this is correct. For gitsim, this command will fail.
        # This is an acceptable limitation for now.
        if [[ -d "$REPO_ROOT/.git" ]]; then
            git add locker.age
        fi
    else
        echo "âœ— Failed to encrypt locker" >&2
        exit 1
    fi
fi
