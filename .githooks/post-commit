#!/usr/bin/env bash
# Post-commit hook: Verify encryption actually occurred

_find_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.git" ]] || [[ -d "$dir/.gitsim" ]]; then
            echo "$dir"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    if [[ -d "$dir/.git" ]] || [[ -d "$dir/.gitsim" ]]; then echo "$dir"; return 0; fi
    return 1
}

REPO_ROOT="$(_find_root)"

# Check if locker.age was modified in this commit
if git diff --name-only HEAD~1..HEAD | grep -q "^locker\.age$"; then
    echo "ðŸ” Verifying locker encryption..."
    
    # Check that locker.age is actually encrypted (contains age header)
    if head -c 30 "$REPO_ROOT/locker.age" 2>/dev/null | grep -q "age-encryption.org"; then
        echo "âœ“ Locker encryption verified"
    else
        echo "âš ï¸  WARNING: locker.age does not appear to be encrypted!"
        echo "âš ï¸  This may indicate git filters were bypassed"
        echo "âš ï¸  Check your git configuration and re-commit if needed"
    fi
    
    # Verify no plaintext locker directory was accidentally committed
    if git ls-files --error-unmatch locker/ >/dev/null 2>&1; then
        echo "ðŸš¨ ERROR: Plaintext locker/ directory found in git!"
        echo "ðŸš¨ This is a security breach - secrets are committed in plaintext"
        echo "ðŸš¨ Run: git reset --soft HEAD~1 && git rm -r --cached locker/"
        exit 1
    fi
fi

exit 0
